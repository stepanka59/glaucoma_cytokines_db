<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ —Ü–∏—Ç–æ–∫–∏–Ω–∞ - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–∏—Ç–æ–∫–∏–Ω–æ–≤</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border: 2px solid #3498db;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: #3498db;
            color: white;
        }
        
        .cytokine-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .cytokine-title {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .cytokine-meta {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            height: 400px;
        }
        
        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        
        .stats-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .stats-table th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .stats-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stats-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .stage-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }
        
        .stage-control { background: #3498db; }
        .stage-1 { background: #2ecc71; }
        .stage-2 { background: #f39c12; }
        .stage-3 { background: #e74c3c; }
        .stage-4 { background: #9b59b6; }
        
        .stat-highlight {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .no-data-cell {
            color: #95a5a6;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="detail-container">
        <a href="index.html" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–∞–±–ª–∏—Ü–µ —Ü–∏—Ç–æ–∫–∏–Ω–æ–≤</a>

        <div class="cytokine-header">
            <h1 class="cytokine-title" id="cytokineName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div class="cytokine-meta" id="cytokineMeta"></div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3>–°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —Å—Ç–∞–¥–∏—è–º</h3>
                <div class="chart-wrapper">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π</h3>
                <div class="chart-wrapper">
                    <canvas id="valuesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <table class="stats-table" id="statsTable">
                <thead>
                    <tr>
                        <th>–°—Ç–∞–¥–∏—è</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (n)</th>
                        <th>–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
                        <th>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                        <th>–ú–∏–Ω–∏–º—É–º</th>
                        <th>–ú–∞–∫—Å–∏–º—É–º</th>
                        <th>–ú–µ–¥–∏–∞–Ω–∞</th>
                    </tr>
                </thead>
                <tbody id="statsBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </tbody>
            </table>
        </div>

        <div style="text-align: center; margin-top: 40px;">
            <button onclick="window.print()" class="btn-primary" style="margin-right: 10px;">üñ®Ô∏è –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞</button>
            <button onclick="downloadReport()" class="btn-secondary">üì• –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <script>
        class CytokineDetailPage {
            constructor() {
                this.cytokineData = null;
                this.charts = {};
                this.init();
            }

            async init() {
                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–∏—Ç–æ–∫–∏–Ω–∞ –∏–∑ URL
                const urlParams = new URLSearchParams(window.location.search);
                const cytokineName = urlParams.get('cytokine');
                
                if (!cytokineName) {
                    this.showError('–¶–∏—Ç–æ–∫–∏–Ω –Ω–µ —É–∫–∞–∑–∞–Ω');
                    return;
                }

                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    const response = await fetch('./data/cytokines_final.json');
                    const data = await response.json();
                    
                    // –ò—â–µ–º –Ω—É–∂–Ω—ã–π —Ü–∏—Ç–æ–∫–∏–Ω
                    this.cytokineData = data.—Ü–∏—Ç–æ–∫–∏–Ω—ã.find(c => c.–Ω–∞–∑–≤–∞–Ω–∏–µ === cytokineName);
                    
                    if (!this.cytokineData) {
                        this.showError(`–¶–∏—Ç–æ–∫–∏–Ω "${cytokineName}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                        return;
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    this.renderPage();
                    this.createCharts();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
            }

            renderPage() {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('cytokineName').textContent = this.cytokineData.–Ω–∞–∑–≤–∞–Ω–∏–µ;
                
                // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const stages = ['control', '1', '2', '3', '4'];
                let totalMeasurements = 0;
                let stagesWithData = 0;
                
                stages.forEach(stage => {
                    const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[stage];
                    if (data && data.n > 0) {
                        totalMeasurements += data.n;
                        stagesWithData++;
                    }
                });
                
                document.getElementById('cytokineMeta').textContent = 
                    `${totalMeasurements} –∏–∑–º–µ—Ä–µ–Ω–∏–π | –î–∞–Ω–Ω—ã–µ –≤ ${stagesWithData} —Å—Ç–∞–¥–∏—è—Ö`;
                
                // –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                this.renderStatsTable();
            }

            renderStatsTable() {
                const tbody = document.getElementById('statsBody');
                const stages = [
                    {id: 'control', name: '–ö–æ–Ω—Ç—Ä–æ–ª—å', class: 'stage-control'},
                    {id: '1', name: '–°—Ç–∞–¥–∏—è 1', class: 'stage-1'},
                    {id: '2', name: '–°—Ç–∞–¥–∏—è 2', class: 'stage-2'},
                    {id: '3', name: '–°—Ç–∞–¥–∏—è 3', class: 'stage-3'},
                    {id: '4', name: '–°—Ç–∞–¥–∏—è 4', class: 'stage-4'}
                ];
                
                let html = '';
                
                stages.forEach(stageInfo => {
                    const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[stageInfo.id];
                    
                    if (data && data.n > 0) {
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ–¥–∏–∞–Ω—É
                        const sortedValues = [...data.–∑–Ω–∞—á–µ–Ω–∏—è].sort((a, b) => a - b);
                        const median = sortedValues.length % 2 === 0 
                            ? (sortedValues[sortedValues.length/2 - 1] + sortedValues[sortedValues.length/2]) / 2
                            : sortedValues[Math.floor(sortedValues.length/2)];
                        
                        const min = Math.min(...data.–∑–Ω–∞—á–µ–Ω–∏—è);
                        const max = Math.max(...data.–∑–Ω–∞—á–µ–Ω–∏—è);
                        
                        html += `
                            <tr>
                                <td><span class="stage-badge ${stageInfo.class}">${stageInfo.name}</span></td>
                                <td class="stat-highlight">${data.n}</td>
                                <td class="stat-highlight">${data.—Å—Ä–µ–¥–Ω–µ–µ.toFixed(4)}</td>
                                <td>${data.—Å—Ç–¥_–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ.toFixed(4)}</td>
                                <td>${min.toFixed(4)}</td>
                                <td>${max.toFixed(4)}</td>
                                <td>${median.toFixed(4)}</td>
                            </tr>
                        `;
                    } else {
                        html += `
                            <tr>
                                <td><span class="stage-badge ${stageInfo.class}">${stageInfo.name}</span></td>
                                <td colspan="6" class="no-data-cell">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                            </tr>
                        `;
                    }
                });
                
                tbody.innerHTML = html;
            }

            createCharts() {
                // –ì—Ä–∞—Ñ–∏–∫ 1: –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                this.createBarChart();
                
                // –ì—Ä–∞—Ñ–∏–∫ 2: –¢–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                this.createValuesChart();
            }

            createBarChart() {
                const ctx = document.getElementById('barChart').getContext('2d');
                const stages = ['–ö–æ–Ω—Ç—Ä–æ–ª—å', '–°—Ç–∞–¥–∏—è 1', '–°—Ç–∞–¥–∏—è 2', '–°—Ç–∞–¥–∏—è 3', '–°—Ç–∞–¥–∏—è 4'];
                const stageIds = ['control', '1', '2', '3', '4'];
                
                const means = stageIds.map(id => {
                    const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[id];
                    return data && data.n > 0 ? data.—Å—Ä–µ–¥–Ω–µ–µ : null;
                });
                
                const errors = stageIds.map(id => {
                    const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[id];
                    return data && data.n > 0 ? data.—Å—Ç–¥_–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ : null;
                });
                
                const backgroundColors = [
                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'
                ];
                
                this.charts.barChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: stages,
                        datasets: [{
                            label: '–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',
                            data: means,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(c => this.darkenColor(c, 20)),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const stageId = stageIds[context.dataIndex];
                                        const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[stageId];
                                        if (!data || data.n === 0) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                                        
                                        return [
                                            `–°—Ä–µ–¥–Ω–µ–µ: ${data.—Å—Ä–µ–¥–Ω–µ–µ.toFixed(2)}`,
                                            `¬± ${data.—Å—Ç–¥_–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ.toFixed(2)} (—Å—Ç. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)`,
                                            `n = ${data.n}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '–£—Ä–æ–≤–µ–Ω—å —ç–∫—Å–ø—Ä–µ—Å—Å–∏–∏'
                                }
                            }
                        }
                    }
                });
            }

            createValuesChart() {
                const ctx = document.getElementById('valuesChart').getContext('2d');
                const stages = ['control', '1', '2', '3', '4'];
                const allValues = [];
                const labels = [];
                const colors = [];
                
                stages.forEach((stage, index) => {
                    const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[stage];
                    if (data && data.n > 0) {
                        data.–∑–Ω–∞—á–µ–Ω–∏—è.forEach(value => {
                            allValues.push(value);
                            labels.push(stage === 'control' ? '–ö–æ–Ω—Ç—Ä–æ–ª—å' : `–°—Ç–∞–¥–∏—è ${stage}`);
                            colors.push(['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'][index]);
                        });
                    }
                });
                
                if (allValues.length === 0) {
                    document.getElementById('valuesChart').parentElement.innerHTML = 
                        '<p style="text-align: center; color: #95a5a6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>';
                    return;
                }
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç–∞–¥–∏—è–º –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const groupedData = [];
                stages.forEach((stage, stageIndex) => {
                    const data = this.cytokineData.—Å—Ç–∞–¥–∏–∏[stage];
                    if (data && data.n > 0) {
                        data.–∑–Ω–∞—á–µ–Ω–∏—è.forEach((value, valueIndex) => {
                            groupedData.push({
                                x: stageIndex + (valueIndex / data.n) * 0.8 - 0.4,
                                y: value,
                                stage: stage
                            });
                        });
                    }
                });
                
                this.charts.valuesChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '–ò–∑–º–µ—Ä–µ–Ω–∏—è',
                            data: groupedData,
                            backgroundColor: groupedData.map(d => 
                                ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'][
                                    ['control', '1', '2', '3', '4'].indexOf(d.stage)
                                ]
                            ),
                            borderColor: groupedData.map(d => 
                                this.darkenColor(
                                    ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'][
                                        ['control', '1', '2', '3', '4'].indexOf(d.stage)
                                    ], 20
                                )
                            ),
                            borderWidth: 1,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '–°—Ç–∞–¥–∏–∏'
                                },
                                min: -0.5,
                                max: 4.5,
                                ticks: {
                                    callback: function(value) {
                                        const stagesNames = ['–ö–æ–Ω—Ç—Ä–æ–ª—å', '–°—Ç–∞–¥–∏—è 1', '–°—Ç–∞–¥–∏—è 2', '–°—Ç–∞–¥–∏—è 3', '–°—Ç–∞–¥–∏—è 4'];
                                        return stagesNames[Math.round(value)] || '';
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '–ó–Ω–∞—á–µ–Ω–∏–µ'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const stageNames = {
                                            'control': '–ö–æ–Ω—Ç—Ä–æ–ª—å',
                                            '1': '–°—Ç–∞–¥–∏—è 1',
                                            '2': '–°—Ç–∞–¥–∏—è 2', 
                                            '3': '–°—Ç–∞–¥–∏—è 3',
                                            '4': '–°—Ç–∞–¥–∏—è 4'
                                        };
                                        const stage = context.raw.stage;
                                        return `${stageNames[stage]}: ${context.parsed.y.toFixed(4)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            darkenColor(color, percent) {
                const num = parseInt(color.slice(1), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                
                return '#' + (
                    0x1000000 +
                    (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)
                ).toString(16).slice(1);
            }

            showError(message) {
                document.querySelector('.detail-container').innerHTML = `
                    <div style="text-align: center; padding: 100px;">
                        <h2 style="color: #e74c3c;">‚ö†Ô∏è –û—à–∏–±–∫–∞</h2>
                        <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
                        <a href="index.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ —Ü–∏—Ç–æ–∫–∏–Ω–æ–≤</a>
                    </div>
                `;
            }
        }

        function downloadReport() {
            const cytokineName = document.getElementById('cytokineName').textContent;
            
            // –°–æ–∑–¥–∞–µ–º CSV —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            let csvContent = "–¶–∏—Ç–æ–∫–∏–Ω;–°—Ç–∞–¥–∏—è;n;–°—Ä–µ–¥–Ω–µ–µ;–°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ;–ú–∏–Ω–∏–º—É–º;–ú–∞–∫—Å–∏–º—É–º;–ú–µ–¥–∏–∞–Ω–∞\n";
            
            const stages = [
                {id: 'control', name: '–ö–æ–Ω—Ç—Ä–æ–ª—å'},
                {id: '1', name: '–°—Ç–∞–¥–∏—è 1'},
                {id: '2', name: '–°—Ç–∞–¥–∏—è 2'},
                {id: '3', name: '–°—Ç–∞–¥–∏—è 3'},
                {id: '4', name: '–°—Ç–∞–¥–∏—è 4'}
            ];
            
            stages.forEach(stageInfo => {
                const data = window.detailPage?.cytokineData?.—Å—Ç–∞–¥–∏–∏[stageInfo.id];
                if (data && data.n > 0) {
                    const sortedValues = [...data.–∑–Ω–∞—á–µ–Ω–∏—è].sort((a, b) => a - b);
                    const median = sortedValues.length % 2 === 0 
                        ? (sortedValues[sortedValues.length/2 - 1] + sortedValues[sortedValues.length/2]) / 2
                        : sortedValues[Math.floor(sortedValues.length/2)];
                    
                    const min = Math.min(...data.–∑–Ω–∞—á–µ–Ω–∏—è);
                    const max = Math.max(...data.–∑–Ω–∞—á–µ–Ω–∏—è);
                    
                    csvContent += `${cytokineName};${stageInfo.name};${data.n};${data.—Å—Ä–µ–¥–Ω–µ–µ.toFixed(4)};${data.—Å—Ç–¥_–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ.toFixed(4)};${min.toFixed(4)};${max.toFixed(4)};${median.toFixed(4)}\n`;
                }
            });
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `cytokine_${cytokineName}_data.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.detailPage = new CytokineDetailPage();
        });
    </script>
</body>
</html>